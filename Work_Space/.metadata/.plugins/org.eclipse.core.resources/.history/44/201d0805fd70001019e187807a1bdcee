#include "stm32f4xx.h"
#include <stdint.h>


#define TIM3EN		(1U<<1)
#define CR1_OPM		(1U<<3)
#define CR1_CEN		(1U<<0)
#define SR_UIF		(1U<<0)


//One-shot delay timer
void tim3_ms_delay(uint32_t delay)
{
	/*Enable clock access to timer3*/
	RCC->APB1ENR |= TIM3EN;

	/*Set timer3 for One-pulse mode*/
	//TIM3->CR1 |= CR1_OPM;

	/*Set prescaler value*/
	TIM3->PSC = 160 - 1; // 16 000 000 / 160 = 100 000

	/*Set auto-reload value*/
	TIM3->ARR = 100; // 100 / 100 000 = 0.001

	/*Clear counter*/
	TIM3->CNT = 0;

	/*Enable timer3*/
	TIM3->CR1 = CR1_CEN;

	for(uint32_t i = 0; i < delay; i++){
		/*Wait for UIF*/
		while(!(TIM3->SR & SR_UIF)){}

		/*Clear UIF*/
		TIM3->SR &= ~SR_UIF;

	}

	/*Disable timer3*/
	TIM3->CR1 = ~CR1_CEN;

}

